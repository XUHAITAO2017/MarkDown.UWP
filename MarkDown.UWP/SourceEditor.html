<!DOCTYPE html>
<html>
<head>
    <title>CodeMirror</title>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <!--<link rel="stylesheet" href="codemirror/lib/font.css">-->
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/markdown/markdown.js"></script>
    <script src="codemirror/addon/selection/active-line.js"></script>
    <!--<script src="codemirror/addon/dialog/dialog.js"></script>-->
    <script src="codemirror/addon/display/fullscreen.js"></script>
    <script src="codemirror/addon/edit/continuelist.js"></script>
    <script src="codemirror/addon/scroll/simplescrollbars.js"></script>
    <script src="codemirror/addon/search/search.js"></script>
    <script src="codemirror/addon/search/searchcursor.js"></script>
    <script src="codemirror/addon/search/jump-to-line.js"></script>
    <!--<link rel="stylesheet" href="codemirror/addon/dialog/dialog.css">-->
    <link rel="stylesheet" href="codemirror/addon/display/fullscreen.css">
    <link rel="stylesheet" href="codemirror/addon/scroll/simplescrollbars.css">
    <!--<style type="text/css">
        .CodeMirror{
            font-family: 'sans-serif'
        }
    </style>-->
</head>
<body>
    <div>
    <textarea id="source"></textarea>
    </div>
    <script>
        var mobile = /Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent);
        var fileref = document.createElement('link');
        fileref.setAttribute("rel", "stylesheet");
        fileref.setAttribute("type", "text/css");
        fileref.setAttribute("href", mobile ? "codemirror/lib/font.mobile.css" : "codemirror/lib/font.css");
        document.getElementsByTagName("head")[0].appendChild(fileref);

        var myCodeMirror = CodeMirror(document.getElementById("source"), {
            fullScreen: true,
            mode: "markdown",
            scrollbarStyle: "overlay",
            dragDrop: false
        });

        myCodeMirror.setOption("extraKeys", {
            "Enter": "newlineAndIndentContinueMarkdownList",
            "Ctrl-F": "findPersistent"
        });        

        myCodeMirror.on("change", function () {
            window.external.notify("change");
        })

        myCodeMirror.on("scroll", function () {
            window.external.notify("scroll");
        })

        var setContent = function (content) {
            myCodeMirror.doc.setValue(content)
        }

        var getContent = function () {
            return myCodeMirror.doc.getValue();
        }

        var getScrollRatio = function () {
            var info = myCodeMirror.getScrollInfo();
            if (info.height <= info.clientHeight)
                return "0";
            else
                return (info.top / (info.height - info.clientHeight)).toString();
        }

        var setFontFamily = function(font){
            myCodeMirror.getWrapperElement().style.fontFamily = font;
        }

        var setLineWrapping = function (v) {
            myCodeMirror.setOption("lineWrapping", v);
        }

        var setShowLineNumber = function (v) {
            myCodeMirror.setOption("lineNumbers", v);
        }

        var setStyleActiveLine = function (v) {
            myCodeMirror.setOption("styleActiveLine", v);
        }

        //Search
        var searchCursor = null;

        CodeMirror.defineOption("searchText", false, function (cm, val, old) {
            //if (old && old != CodeMirror.Init) {
            //    removeOverlay(cm);
            //    clearTimeout(cm.state.matchHighlighter.timeout);
            //    cm.state.matchHighlighter = null;
            //    cm.off("cursorActivity", cursorActivity);
            //}
            //if (val) {
            //    cm.state.matchHighlighter = new State(val);
            //    highlightMatches(cm);
            //    cm.on("cursorActivity", cursorActivity);
            //}
        });

        var setSearchText = function (query, isMatchCase) {
            //if (query == null || query == "") {
            //    clearSearchState();

            //} else {
            //    searchCursor = myCodeMirror.getSearchCursor(query, 0, isMatchCase);
            //    searchCursor.findNext();
            //    updateSearchState();
            //}

            myCodeMirror.setOption("searchText", query);
            myCodeMirror.execCommand("find");
        }

        var findNext = function(){
            //if (searchCursor) {
            //    searchCursor.findNext();
            //    updateSearchState();
            //}
            myCodeMirror.execCommand("findNext");

        }

        var findPrevious = function () {
            //if (searchCursor) {
            //    searchCursor.findPrevious();
            //    updateSearchState();
            //}
            myCodeMirror.execCommand("findPrev");
        }

        //function updateSearchState (){
        //    if (searchCursor.from() != null) {
        //        myCodeMirror.setSelection(searchCursor.from(), searchCursor.to());
        //        myCodeMirror.scrollIntoView({ from: searchCursor.from(), to: searchCursor.to() });
        //        //isFindNextEnabled = true;
        //    } else {
        //        //isFindNextEnabled = false;
        //    }
            
        //    window.external.notify("SearchStateChanged");
        //}

        //function clearSearchState() {
        //    searchCursor = null;
        //    myCodeMirror.setSelection({ line: 0, ch: 0 });
        //}

        //var isFindNextEnabled = false;
    </script>
</body>
</html>